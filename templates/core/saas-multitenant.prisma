// Module: Core SaaS Multitenant
// Purpose: Encapsulates tenant lifecycle, environments, provisioning, and seat allocations for SaaS platforms.

enum TenantStatus {
  PROVISIONING
  ACTIVE
  SUSPENDED
  DELETING
}

enum EnvironmentType {
  PRODUCTION
  STAGING
  DEVELOPMENT
  SANDBOX
}

enum ProvisioningStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
}

model Tenant {
  id             String       @id @default(cuid())
  organizationId String
  slug           String
  status         TenantStatus @default(PROVISIONING)
  region         String       @default("us-east-1")
  planTier       String       @default("standard")
  seatLimit      Int          @default(10)
  metadata       Json?
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([slug])
  @@index([organizationId])
  @@index([status])
}

model TenantEnvironment {
  id           String         @id @default(cuid())
  tenantId     String
  type         EnvironmentType
  apiDomain    String
  appUrl       String
  secrets      Json?
  lastDeployedAt DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([tenantId, type])
  @@index([apiDomain])
}

model TenantProvisioningTask {
  id         String            @id @default(cuid())
  tenantId   String
  code       String
  status     ProvisioningStatus @default(QUEUED)
  payload    Json?
  result     Json?
  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@index([tenantId, status])
  @@index([code])
}

model TenantSeatAllocation {
  id         String   @id @default(cuid())
  tenantId   String
  seatType   String   @default("member")
  limit      Int      @default(0)
  consumed   Int      @default(0)
  updatedBy  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([tenantId, seatType])
}

// Integration:
// - Depends on business/organizations.prisma for the Organization aggregate
// - Inform infra/api-keys and billing modules to scope tenant resources
// Notes:
// - Soft delete tenants via deletedAt while preserving linked billing/audit history
// - Seat allocations let you enforce per-plan limits without recalculating usage tables
